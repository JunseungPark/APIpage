<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"> -->
    <title>weather APi</title>
    <!-- stylesheet -->
    <link rel="stylesheet" href="../../assets/style/fonts.css">
    <link rel="stylesheet" href="../../assets/style/reset.css">
    <link rel="stylesheet" href="../../assets/style/api.css">

    <!-- Ramaraja font -->
    <link href="https://fonts.googleapis.com/css2?family=Ramaraja&display=swap" rel="stylesheet">
    <!-- Rakkas font -->
    <link href="https://fonts.googleapis.com/css2?family=Rakkas&display=swap" rel="stylesheet">
</head>
<body>
    <header id="header">
        <h2 class="header_title">map</h2>
    </header>

    <main id="main">
        <div class="main_contents map_main_contents">
            <div class="main_desc">
                <span><strong>안녕하세요 API 프로젝트, 노인정입니다!</strong>세 번째 활용해 본 API는 Map을 이용한 일정 만들기 기능입니다. 나의 일정을 지도에 표기하여 나타낼 수 있고 해당 일정을 효과적으로 나타내기 위해서 중간에 경유지를 추가하여 안전하게 도착지까지 갈 수 있도록 기획하였습니다. 아래에서 직접 경로를 지정해보세요!<em>Bye: Youn, Park, Song, Jo</em></span>
            </div>
            <div id="status"></div>

            <div id="smain">
                <article class="content-article">
                    <section class="schedule">
                        <h2 class="ir_so">일정 만들기</h2>
                        <div class="route">
                            <h3>일정 만들기</h3>
                            <div class="wrap">
                                <div class="circle-wrap">
                                    <div class="circle"></div>
                                    <div class="circle"></div>
                                    <div class="circle"></div>
                                </div>
                                <table class="ij__js">
                                    <tr>
                                        <td>일정1</td>
                                    </tr>
                                    <tr>
                                        <td>일정2</td>
                                    </tr>
                                    <tr>
                                        <td>일정3</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <h2 class="ir_so">제목 내용쓰기</h2>
                        <div class="route">
                            <h3>여행 제목</h3>
                            <textarea type="text" class="wrap title" rows="2" placeholder="여행계획의 제목을 적어주세요."></textarea>
                            <h3> 소개</h3>
                            <textarea name="text" class="wrap intro" cols="30" rows="10" placeholder="여행계획에 대한 간단한 설명을 적어주세요."></textarea>
                            <div class="comment-wrap">
                                <span class="comment white">
                                    <a href="#">일정 저장하기</a>
                                </span>
                                <span class="comment">
                                    <a href="#">일정 공유하기</a>
                                </span>
                            </div>
                        </div>
                    </section>
                    <section class="map">
                        <div class="overlay">
                            <span>클릭하여 검색할 키워드나 주소를 입력하세요</span>
                        </div>
                        <div id="map" style="width:100%;height:100%;"></div>
                    </section>
                </article>
            </div>
        </div>
        <figure class="back_main"><img src="../../assets/img/maintag.jpg" />
            <figcaption><span>Main</span></figcaption>
            <a href="../main.html"></a>
        </figure>
    </main>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=743052ac63b739e5aaf4218317bfca12&libraries=services"></script>
    <script type="text/javascript" src="../assets/js/map.js"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>

        // 장소 검색 객체를 생성합니다
        var ps = new kakao.maps.services.Places(); 

        // 키워드로 장소를 검색합니다
        
        
        document.querySelector(".overlay span").addEventListener("click",()=>{
            document.querySelector(".overlay span").innerHTML= "";
            new daum.Postcode({
                oncomplete: function(data) {
  
                    // 주소로 좌표를 검색합니다
                    geocoder.addressSearch(data.address, function(result, status) {
                        
                    // marker.setPosition(mouseEvent.latLng);
                    // 정상적으로 검색이 완료됐으면 
                    if (status === kakao.maps.services.Status.OK) {

                        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                        // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
                        map.setCenter(coords);
                        zoomIn()
                        document.querySelector(".overlay span").innerHTML= "클릭하여 검색할 키워드나 주소를 입력하세요";
                    } 
                    });
                }
            }).open();
        });
        document.querySelectorAll(".js__submit").forEach((button)=>{
            button.addEventListener("click",(e)=>{
                const ilJungLength = document.querySelectorAll('.ij__js td').length;
                const textLength   = document.querySelector(".title").textLength;
                const introLength  = document.querySelector(".intro").textLength;
                const gps = document.querySelector('input[name=gps]');
                if( ilJungLength !== getInfomration().length ){
                    e.preventDefault();
                    alert("지도에서 3개의 마커를 선택 해주세요.");
                    return false;
                } 
                if( textLength == 0 && introLength == 0 ){
                    e.preventDefault();
                    alert("여행 제목과 소개 내용을 입력해주세요.");
                    return false;
                }
                gps.value = JSON.stringify(getInfomration());      
            });
        });
    


        function zoomIn() {        
            // 현재 지도의 레벨을 얻어옵니다
            var level = map.getLevel();
            
            // 지도를 1레벨 내립니다 (지도가 확대됩니다)
            map.setLevel(level - 3);

        }    

        function zoomOut() {    
            // 현재 지도의 레벨을 얻어옵니다
            var level = map.getLevel(); 
            
            // 지도를 1레벨 올립니다 (지도가 축소됩니다)
            map.setLevel(level + 1);

        }    

        var counter = {
            idx : 0,
            add : function(){
                this.idx = this.idx + 1;
            },
            minus : function(){
                this.idx = this.idx - 1;
            },
            show : function(){
                return this.idx;
            }
        }
        var markerArray = [
            {
                imageSrc : "../../assets/img/start.png",
                imageSize : new kakao.maps.Size(50, 50),
                imageOption : {offset: new kakao.maps.Point(25, 48)}
            },
            {
                imageSrc : "../../assets/img/route.png",
                imageSize : new kakao.maps.Size(50, 50),
                imageOption : {offset: new kakao.maps.Point(25, 48)}
            },
            {
                imageSrc : "../../assets/img/end.png",
                imageSize : new kakao.maps.Size(50, 50),
                imageOption : {offset: new kakao.maps.Point(25, 48)}
            }
        ]

        var markers = [];
        var drawingFlag = false; // 선이 그려지고 있는 상태를 가지고 있을 변수입니다
        var moveLine; // 선이 그려지고 있을때 마우스 움직임에 따라 그려질 선 객체 입니다

        var distanceOverlay; // 선의 거리정보를 표시할 커스텀오버레이 입니다
        var dots = {}; // 선이 그려지고 있을때 클릭할 때마다 클릭 지점과 거리를 표시하는 커스텀 오버레이 배열입니다.



        var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
        mapOption = { 
            center: new kakao.maps.LatLng(33.450701, 126.570667), // 지도의 중심좌표
            level: 3 // 지도의 확대 레벨
        };

        // 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
        var map = new kakao.maps.Map(mapContainer, mapOption); 

        // 일반 지도와 스카이뷰로 지도 타입을 전환할 수 있는 지도타입 컨트롤을 생성합니다
        var mapTypeControl = new kakao.maps.MapTypeControl();

        // 지도에 컨트롤을 추가해야 지도위에 표시됩니다
        // kakao.maps.ControlPosition은 컨트롤이 표시될 위치를 정의하는데 TOPRIGHT는 오른쪽 위를 의미합니다
        map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

        // 지도 확대 축소를 제어할 수 있는  줌 컨트롤을 생성합니다
        var zoomControl = new kakao.maps.ZoomControl();
        map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

        /*
            =====================
        */
        // 주소-좌표 변환 객체를 생성합니다
        var geocoder = new kakao.maps.services.Geocoder();

        function addMarker(position) {
            
            // 마커를 생성합니다
            var markerImage = new kakao.maps.MarkerImage(markerArray[counter.show()].imageSrc, markerArray[counter.show()].imageSize, markerArray[counter.show()].imageOption );
            var marker = new kakao.maps.Marker({
                position: position,
                image: markerImage // 마커이미지 설정 
            });
            var nowindex = counter.show()
            // 좌표로 검색한 위치입니다 
            searchDetailAddrFromCoords(position, function(result, status) {
                let address = "";
                if (status === kakao.maps.services.Status.OK) {
                    if( result[0]['road_address'] ){
                
                        if(result[0]['road_address']['building_name']==""){
                            address = result[0].address.address_name;
                        } else {
                            address = result[0].road_address.building_name
                        }
            
                    } else {
                        address = result[0].address.address_name;
                    }
                    document.querySelectorAll(".ij__js td")[nowindex].innerHTML = address;
                }

            })
            // 마커가 지도 위에 표시되도록 설정합니다
            marker.setMap(map);
            // 생성된 마커를 배열에 추가합니다
            markers.push(marker);
            counter.add();

        }

        /*
            info = [
                {
                    Ma : 0,
                    La : 0
                }
                
            ] 
        */
        function getInfomration(){
            let info = [];
            markers.forEach((el) =>{
                info.push({
                    "Ma" : el.getPosition().Ma,
                    "La" : el.getPosition().La
                });
            });
            return info;
        }

        function addLine(array) {
            //좌표 path 만들기
            var array2 = [];
            map.panTo(new kakao.maps.LatLng(array[0].Ma, array[0].La));
            clickLine = new kakao.maps.Polyline({
                map: map, // 선을 표시할 지도입니다 
                path: [new kakao.maps.LatLng(array[0].Ma, array[0].La)], // 선을 구성하는 좌표 배열입니다 클릭한 위치를 넣어줍니다
                strokeWeight: 6, // 선의 두께입니다 
                strokeColor: '#3396FF', // 선의 색깔입니다
                strokeOpacity: 0.9, // 선의 불투명도입니다 0에서 1 사이값이며 0에 가까울수록 투명합니다
                strokeStyle: 'solid' // 선의 스타일입니다
            });

            
            for( let i = 0 ; i < array.length ; i++ ){
                array2.push(new kakao.maps.LatLng(array[i].Ma, array[i].La))
                //마커 찍기
                addMarker(new kakao.maps.LatLng(array[i].Ma, array[i].La))
            }
            clickLine.setPath(array2);
        }


            // infowindow = new kakao.maps.InfoWindow({zindex:1}); 클릭한 위치에 대한 주소를 표시할 인포윈도우입니다

        // 현재 지도 중심좌표로 주소를 검색해서 지도 좌측 상단에 표시합니다
        // searchAddrFromCoords(map.getCenter(), displayCenterInfo);

        // 지도를 클릭했을 때 클릭 위치 좌표에 대한 주소정보를 표시하도록 이벤트를 등록합니다
        var clickLine // 마우스로 클릭한 좌표로 그려질 선 객체입니다
        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            if( counter.show() >= document.querySelectorAll(".ij__js td").length -1 )  map.setLevel(7)
            if( counter.show() >= document.querySelectorAll(".ij__js td").length ){
                alert("경로는 최대3개 까지 등록 가능합니다.");
                return false;
            }
            
            searchDetailAddrFromCoords(mouseEvent.latLng, function(result, status) {
                // 마우스로 클릭한 위치입니다 
                var clickPosition = mouseEvent.latLng;
                var latlng = mouseEvent.latLng;
                console.log("latLng",clickPosition)
                // function deleteClickLine() {
                //     if (clickLine) {
                //         clickLine.setMap(null);    
                //         clickLine = null;        
                //     }
                // }
                function deleteCircleDot() {
                    var i;
                
                    for ( i = 0; i < dots.length; i++ ){
                        if (dots[i].circle) { 
                            dots[i].circle.setMap(null);
                        }
                
                        if (dots[i].distance) {
                            dots[i].distance.setMap(null);
                        }
                    }
                
                    dots = [];
                }
                function deleteDistnce () {
                    if (distanceOverlay) {
                        distanceOverlay.setMap(null);
                        distanceOverlay = null;
                    }
                }
                if (status === kakao.maps.services.Status.OK) {
                    var markerImage = new kakao.maps.MarkerImage(markerArray[counter.show()].imageSrc, markerArray[counter.show()].imageSize, markerArray[counter.show()].imageOption );

                    var marker = new kakao.maps.Marker({
                        position: clickPosition,
                        image: markerImage // 마커이미지 설정 
                    });
                    
                    /* 핑 이어주기 */


                    // 지도 클릭이벤트가 발생했는데 선을 그리고있는 상태가 아니면
                    if (!drawingFlag) {
                        
                        // 상태를 true로, 선이 그리고있는 상태로 변경합니다
                        drawingFlag = true;
                        
                        // 지도 위에 선이 표시되고 있다면 지도에서 제거합니다
                        // deleteClickLine();
                        
                        // 지도 위에 커스텀오버레이가 표시되고 있다면 지도에서 제거합니다
                        // deleteDistnce();

                        // 지도 위에 선을 그리기 위해 클릭한 지점과 해당 지점의 거리정보가 표시되고 있다면 지도에서 제거합니다
                        deleteCircleDot();
                    
                        // 클릭한 위치를 기준으로 선을 생성하고 지도위에 표시합니다
                        clickLine = new kakao.maps.Polyline({
                            map: map, // 선을 표시할 지도입니다 
                            path: [clickPosition], // 선을 구성하는 좌표 배열입니다 클릭한 위치를 넣어줍니다
                            strokeWeight: 6, // 선의 두께입니다 
                            strokeColor: '#3396FF', // 선의 색깔입니다
                            strokeOpacity: 0.9, // 선의 불투명도입니다 0에서 1 사이값이며 0에 가까울수록 투명합니다
                            strokeStyle: 'solid' // 선의 스타일입니다
                        });
                        

                        // 선이 그려지고 있을 때 마우스 움직임에 따라 선이 그려질 위치를 표시할 선을 생성합니다
                        moveLine = new kakao.maps.Polyline({
                            strokeWeight: 6, // 선의 두께입니다 
                            strokeColor: '#3396FF', // 선의 색깔입니다
                            strokeOpacity: 0.9, // 선의 불투명도입니다 0에서 1 사이값이며 0에 가까울수록 투명합니다
                            strokeStyle: 'solid' // 선의 스타일입니다    
                        });
                    

                            
                    } else { // 선이 그려지고 있는 상태이면
            
                        // 그려지고 있는 선의 좌표 배열을 얻어옵니다
                        var path = clickLine.getPath();
                        
                        // 좌표 배열에 클릭한 위치를 추가합니다
                        path.push(clickPosition);
                        
                        // 다시 선에 좌표 배열을 설정하여 클릭 위치까지 선을 그리도록 설정합니다
                        console.log(path);
                        clickLine.setPath(path);
                        
                        // var distance = Math.round(clickLine.getLength());
                        // displayCircleDot(clickPosition, distance);
                    }
                    let address = "";

                    if( result[0]['road_address'] ){
                    
                        if(result[0]['road_address']['building_name']==""){
                            address = result[0].address.address_name;
                        } else {
                            address = result[0].road_address.building_name
                        }

                    } else {
                        address = result[0].address.address_name;
                    }
                    
                    // 마커를 클릭한 위치에 표시합니다 
                    marker.setPosition(mouseEvent.latLng);
                    marker.setMap(map);
                    markers.push(marker);

                    var nowCount = counter.show();
                    
                    document.querySelectorAll(".ij__js td")[nowCount].innerHTML = address;
                    
                    counter.add();
                    
                    //마커를 클릭했을때 이벤트를 등록합니다. => 마커 삭제
                    kakao.maps.event.addListener(marker, 'click', function(e) {

                        //삭제할 마커를 클릭했을때 마지막번째의 마커를 클릭하지 않으면 클릭 취소
                        if(nowCount !== counter.show()-1 ){
                            alert("마지막에 클릭한 요소를 선택해주세요!");
                            return false;
                        }

                        //현재 마커를 제거함
                        markers[nowCount].setMap(null);
                        
                        
                        if( nowCount === 0 ){                
                            clickLine.setPath(null);
                            clickLine = "";
                            drawingFlag = false;
                        } else {
                            path.pop();
                            clickLine.setPath(path);
                        }

                        //제거한 마커를 마커배열에서 제거
                        markers.pop();
                        document.querySelectorAll(".ij__js td")[nowCount].innerHTML = "";
                        counter.minus();
                    });
                }   
            });
        });

        // 중심 좌표나 확대 수준이 변경됐을 때 지도 중심 좌표에 대한 주소 정보를 표시하도록 이벤트를 등록합니다
        // kakao.maps.event.addListener(map, 'idle', function() {
        //     searchAddrFromCoords(map.getCenter(), displayCenterInfo);
        // });

        function searchAddrFromCoords(coords, callback) {
            // 좌표로 행정동 주소 정보를 요청합니다
            geocoder.coord2RegionCode(coords.getLng(), coords.getLat(), callback);         
        }

        function searchDetailAddrFromCoords(coords, callback) {
            // 좌표로 법정동 상세 주소 정보를 요청합니다
            geocoder.coord2Address(coords.getLng(), coords.getLat(), callback);
        }

        // 지도 좌측상단에 지도 중심좌표에 대한 주소정보를 표출하는 함수입니다
        // function displayCenterInfo(result, status) {
        //     if (status === kakao.maps.services.Status.OK) {
        //         var infoDiv = document.getElementById('centerAddr');

        //         for(var i = 0; i < result.length; i++) {
        //             // 행정동의 region_type 값은 'H' 이므로
        //             if (result[i].region_type === 'H') {
        //                 infoDiv.innerHTML = result[i].address_name;
        //                 break;
        //             }
        //         }
        //     }    
        // }



        // 키워드 검색 완료 시 호출되는 콜백함수 입니다
        function placesSearchCB (data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {

                // 검색된 장소 위치를 기준으로 지도 범위를 재설정하기위해
                // LatLngBounds 객체에 좌표를 추가합니다
                var bounds = new kakao.maps.LatLngBounds();

                for (var i=0; i<data.length; i++) {
                    displayMarker(data[i]);    
                    bounds.extend(new kakao.maps.LatLng(data[i].y, data[i].x));
                }       

                // 검색된 장소 위치를 기준으로 지도 범위를 재설정합니다
                map.setBounds(bounds);
            } 
        }
    </script>
</body>
</html>